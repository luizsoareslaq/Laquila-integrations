<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Laquila API Docs</title>
    <link rel="stylesheet" type="text/css" href="./swagger-ui.css" />
    <script src="./swagger-ui-bundle.js"></script>
    <script src="./swagger-ui-standalone-preset.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        body {
            background-color: black;
            color: white !important;
        }

        .swagger-ui {
            color: white !important;
        }

        .swagger-ui .opblock-tag,
        .swagger-ui .info .title,
        .swagger-ui a.nostyle,
        .swagger-ui table thead tr td,
        .swagger-ui table thead tr th,
        .swagger-ui .parameter__name,
        .swagger-ui .response-col_status,
        .swagger-ui section.models.is-open h4,
        .swagger-ui .model-title,
        .swagger-ui .model,
        .swagger-ui .tab li button.tablinks,
        .swagger-ui .response-col_links
        {
            color: white !important;
        }

        .swagger-ui .opblock .opblock-section-header h4{
            color: black !important;
        }

        .swagger-ui .scheme-container {
            background-color: black;
        }

        .login-screen {
            width: 100vw;
            height: 100vh;
            justify-content: center;
            align-items: center;
            display: flex;
            background-color: #0d1117;
        }

        #login-container {
            color: #fff;
            text-align: center;
            background: #161b22;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 320px;
        }

        .login input {
            padding: 10px;
            width: 100%;
            margin: 6px 0;
            border: 1px solid #30363d;
            border-radius: 5px;
            background: #0d1117;
            color: white;
        }

        .login button {
            padding: 10px 20px;
            background: #238636;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            margin-top: 10px;
            width: 100%;
        }

        .login button:hover {
            background: #2ea043;
        }

        #logout-btn {
            position: fixed;
            top: 15px;
            right: 20px;
            background: #da3633;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            z-index: 9999;
            color: white;
            cursor: pointer;
            display: none;
        }

        #logout-btn:hover {
            background: #f85149;
        }
    </style>
</head>

<body>
    <div class="login-screen" id="login-screen">

        <div id="login-container" class="login">
            <h2>Login Laquila Integrations API</h2>
            <input type="text" id="company" placeholder="CNPJ da Empresa" /><br />
            <input type="text" id="username" placeholder="Usuário" /><br />
            <input type="password" id="password" placeholder="Senha" /><br />
            <button onclick="login()">Entrar</button>
        </div>
    </div>

    <button id="logout-btn" onclick="logout()">Sair</button>
    <div id="swagger-ui" style="display:none;"></div>

    <script>
        async function login() {
            const company = document.getElementById("company").value.trim();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();

            // return

            if (!company || !username || !password) {
                alert("Preencha todos os campos");
                return;
            }

            try {
                const response = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ company, username, password }),
                });

                if (!response.ok) {
                    alert("Falha no login");
                    return;
                }

                const data = await response.json();

                const token = data.jwt_token;

                if (!token) {
                    alert("Token não encontrado na resposta");
                    return;
                }

                // salva token e CNPJ no storage
                localStorage.setItem("jwt_token", token);
                localStorage.setItem("cnpj", company);

                initSwagger(token);
            } catch (e) {
                alert("Erro de conexão");
                console.error(e);
            }
        }

        function initSwagger(token) {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("swagger-ui").style.display = "block";
            document.getElementById("logout-btn").style.display = "block";

            SwaggerUIBundle({
                url: "/swagger/v1/swagger.json",
                dom_id: "#swagger-ui",
                presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
                layout: "BaseLayout",
                requestInterceptor: (req) => {
                    req.headers["Authorization"] = "Bearer " + token;
                    const cnpj = localStorage.getItem("cnpj");
                    if (cnpj) req.headers["X-Company-CNPJ"] = cnpj;
                    return req;
                },
            });

            const decoded = parseJwt(token);
            const roles = decoded?.["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
            const rolesArray = Array.isArray(roles) ? roles : [roles];

            console.log(roles);

            const schemaCheck = setInterval(() => {
                const schemaSection = document.querySelector('.models');

                if (!schemaSection) return;

                if (!rolesArray.includes("Admin")) {
                    schemaSection.style.display = "none";
                }

                clearInterval(schemaCheck);
            }, 300);
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                if (!base64Url) throw new Error("Token malformado");

                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c =>
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );

                const payload = JSON.parse(jsonPayload);

                const now = Math.floor(Date.now() / 1000);
                if (payload.exp && payload.exp < now) {
                    console.warn("Token expirado.");
                    logout();
                    return null;
                }

                return payload;
            } catch (err) {
                console.warn("JWT inválido, deslogando...", err);
                logout();
                return null;
            }
        }

        function logout() {
            localStorage.removeItem("jwt_token");
            localStorage.removeItem("cnpj");
            location.reload();
        }

        // auto login se o token já existir
        const saved = localStorage.getItem("jwt_token");
        if (saved) initSwagger(saved);
    </script>
</body>

</html>